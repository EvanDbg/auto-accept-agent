# Auto Accept Agent — 功能分析与增强建议

## 当前已实现功能总览

| 功能模块 | 描述 | 状态 |
|---------|------|------|
| 自动接受文件编辑 | Accept All / Accept Changes 按钮自动点击 | ✅ |
| 自动运行终端命令 | Run Command 按钮自动点击 | ✅ |
| 自动重试 | Retry 按钮自动点击 + 智能延迟 | ✅ |
| 危险命令拦截 | 基于模式匹配阻止破坏性命令 | ✅ |
| 重试熔断器 | 连续失败 5 次后停止自动重试 | ✅ |
| 后台模式 | 多标签页轮询 + Overlay 状态面板 | ✅ |
| ROI 统计 | 点击计数、节省时间计算、周报通知 | ✅ |
| 智能轮询间隔 | 无点击时自动降频，有操作时恢复 | ✅ |
| 多 IDE 支持 | Antigravity + Cursor 双模式 | ✅ |
| CDP 端口智能检测 | 跨平台自动发现 debug 端口 | ✅ |
| 快捷方式自动修改 | Windows/macOS/Linux 添加 CDP flag | ✅ |
| 设置面板 | WebView 设置界面 + Pro 订阅管理 | ✅ |
| 多语言支持 | 英文 + 简体中文 | ✅ |
| Step Requires Input 处理 | 展开折叠按钮 + 滚动显示隐藏按钮 | ✅ |
| 对话完成检测 | Good/Bad badge 检测停止无效点击 | ✅ |

---

## 建议增加的功能

### 🔥 高价值 / 低难度

#### 1. 操作日志 & 历史记录面板

**痛点**: 用户离开后回来，不知道 Auto Accept 做了什么。

**方案**: 将每次自动操作（Accept / Run / Retry / Blocked）记录到持久化日志，并在设置面板中提供"操作历史"标签页。

```
[14:32:15] ✅ Accept All — utils.ts, config.js (2 files)
[14:32:18] ✅ Run Command — npm test
[14:33:01] 🚫 Blocked — rm -rf /tmp/build (匹配规则: rm -rf)
[14:35:22] 🔄 Retry — Agent terminated due to error (attempt 2/5)
```

**实现要点**:
- 在 `full_cdp_script.js` 的 `performClick` 中记录操作到 `window.__autoAcceptState.actionLog`
- 通过 CDP 轮询拉取日志到 extension 侧
- 使用 VS Code `outputChannel` 或 WebView 展示

---

#### 2. 通知声音 / 系统通知

**痛点**: 任务完成或熔断器触发时用户可能在做其他事情。

**方案**: 在以下事件触发桌面通知或声音提示：
- 所有对话均完成（全部出现 Good/Bad badge）
- 重试熔断器触发
- 危险命令被拦截

**实现要点**:
- 使用 `vscode.window.showInformationMessage` 已有机制，增加系统通知
- 可选添加声音提示（使用 VS Code `audibleBell` API 或播放音频文件）

---

#### 3. 自动接受的白名单 / 黑名单过滤

**痛点**: 当前只能全局开关文件编辑自动接受，无法按文件类型过滤。

**方案**: 允许用户指定：
- **白名单**: 只自动接受特定文件类型的编辑（如 `.ts`, `.js`）
- **黑名单**: 不自动接受某些敏感文件的编辑（如 `.env`, `package.json`, `Dockerfile`）

**实现要点**:
- 在设置中添加 `autoAccept.fileEditFilter` 配置
- 在 `isAcceptButton` 中通过 `findNearbyCommandText` 类似方法提取文件名，匹配过滤规则

---

#### 4. 暂停/恢复功能（替代完全关闭）

**痛点**: 用户临时想手动操作一下，但停止 Auto Accept 后需要重新启动。

**方案**: 添加"暂停"状态：
- 状态栏增加暂停按钮
- 暂停期间保持 CDP 连接但停止点击
- 可设置自动恢复时间（如暂停 5 分钟后自动恢复）

---

### ⭐ 中价值 / 中难度

#### 5. 对话进度追踪 Dashboard

**痛点**: 后台模式 overlay 信息有限，用户想知道每个对话的详细进展。

**方案**: 增强现有 overlay 或创建独立 WebView dashboard：
- 每个对话显示：当前步骤数、已接受操作数、最后操作时间
- 对话间进度对比
- 预估完成时间

---

#### 6. 命令确认延迟（"Review Window"）

**痛点**: 某些命令虽然不在黑名单但用户想先看看。

**方案**: 添加可配置的"确认窗口"：
- 对特定类型操作（如终端命令）延迟 N 秒
- 延迟期间在状态栏显示倒计时
- 用户可在倒计时内取消操作
- 类似 Gmail 的"撤回发送"模式

---

#### 7. 多窗口/多实例统一管理

**痛点**: 多个 VS Code 窗口各自运行 Auto Accept，状态不同步。

**方案**: 
- 使用文件锁或 IPC 选举主控实例
- 主实例汇总所有窗口的状态
- 提供统一的管理界面

---

#### 8. 自动保存对话摘要

**痛点**: 对话完成后没有自动记录做了什么。

**方案**: 检测到 Good/Bad badge 时：
- 提取对话标题
- 记录操作统计（接受了多少文件编辑、执行了多少命令）
- 保存到本地文件或通知用户

---

### 💡 探索性 / 高难度

#### 9. 智能命令风险评估

**痛点**: 黑名单是静态的，无法覆盖所有危险场景。

**方案**: 基于规则引擎的命令风险评分：
- `rm` → 高风险
- `chmod 777` → 中风险
- `npm install` → 低风险
- 根据评分决定：自动执行 / 延迟确认 / 阻止

---

#### 10. WebSocket 实时通信（替代轮询）

**痛点**: 当前依赖定时轮询检测按钮，有延迟且浪费资源。

**方案**: 使用 MutationObserver + WebSocket 实时推送：
- 在注入脚本中用 MutationObserver 监听按钮出现
- 通过 CDP 建立的 WebSocket 实时通知 extension
- 减少 CPU 占用，提高响应速度

---

#### 11. 操作回滚 / 撤销

**痛点**: 自动接受了不想要的编辑，需要手动 git 恢复。

**方案**: 
- 在 Accept 前自动 git stash 或创建临时分支
- 提供一键回滚到 Accept 前的状态
- 可选：保留 diff 记录供后续审查

---

## 优先级建议

| 优先级 | 功能 | 原因 |
|--------|------|------|
| P0 | 操作日志 & 历史记录 | 核心可见性需求，实现简单 |
| P0 | 暂停/恢复 | 用户体验基本功能 |
| P1 | 通知声音 & 系统通知 | 后台模式必备 |
| P1 | 文件编辑白名单/黑名单 | 安全性增强 |
| P2 | 命令确认延迟 | 安全与效率平衡 |
| P2 | 对话进度 Dashboard | 后台模式体验增强 |
| P3 | 自动保存对话摘要 | 附加价值 |
| P3 | 多窗口统一管理 | 高级场景 |
| P4 | 智能命令风险评估 | 探索性功能 |
| P4 | WebSocket 替代轮询 | 架构优化 |
| P4 | 操作回滚 | 安全网，实现复杂 |
